<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ—¥æ—…éŠå¿ƒå¾—å ±å‘Šç”¢ç”Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.25), 
                        0 0 0 1px rgba(255,255,255,0.2);
            overflow: hidden;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 800;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 20px rgba(0,0,0,0.2);
            letter-spacing: -1px;
        }

        .header p {
            font-size: 1.15em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 400;
        }

        .content {
            padding: 50px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 30px 20px;
            }
        }

        .api-section {
            background: linear-gradient(135deg, #d4f1d7 0%, #c8e6c9 100%);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 35px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.1);
            transition: all 0.3s ease;
        }

        .api-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
        }

        .api-section h3 {
            color: #2e7d32;
            margin-bottom: 18px;
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-section input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .api-section input:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.1);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 40px;
            border-bottom: 2px solid #f0f0f0;
            overflow-x: auto;
            padding: 0 5px;
        }

        .tab {
            padding: 16px 28px;
            background: transparent;
            border: none;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            color: #888;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.08);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 28px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.05em;
            letter-spacing: -0.2px;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #fafbfc;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .image-upload {
            border: 3px dashed #c5d4e8;
            border-radius: 16px;
            padding: 45px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            position: relative;
            overflow: hidden;
        }

        .image-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-upload:hover {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8efff 100%);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .image-upload:hover::before {
            opacity: 1;
        }

        .image-upload.dragover {
            background: linear-gradient(135deg, #e8efff 0%, #dbe7ff 100%);
            border-color: #667eea;
            border-width: 3px;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .image-preview {
            display: none;
            margin-top: 20px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .image-preview.active {
            display: flex;
        }

        .preview-item {
            position: relative;
            width: 110px;
            height: 110px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transition: all 0.3s ease;
        }

        .preview-item:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.18);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(244, 67, 54, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .preview-item:hover .remove-image {
            opacity: 1;
        }

        .remove-image:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .day-list {
            display: grid;
            gap: 24px;
            margin-bottom: 30px;
        }

        .day-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }

        .day-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
        }

        .day-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .day-card-header h3 {
            color: #667eea;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .day-card-content {
            color: #4a5568;
            line-height: 1.8;
        }

        .day-card-content p {
            margin-bottom: 12px;
            font-size: 1.02em;
        }

        .day-card-content strong {
            color: #2d3748;
            font-weight: 700;
        }

        .day-card-images {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .day-card-images img {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .day-card-images img:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        }

        .btn-delete {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .spinner {
            border: 5px solid #f3f4f6;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #667eea;
            font-weight: 600;
            font-size: 1.05em;
        }

        .error-message {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c62828;
            padding: 18px 22px;
            border-radius: 12px;
            margin-top: 25px;
            display: none;
            border-left: 4px solid #c62828;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.15);
            font-weight: 500;
        }

        .error-message.active {
            display: block;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 18px;
            padding: 35px;
            margin-top: 35px;
            display: none;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.15);
        }

        .result-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .result-section h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-content {
            line-height: 2;
            font-size: 1.08em;
            color: #2d3748;
            white-space: pre-wrap;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }

        .hint {
            font-size: 0.92em;
            color: #718096;
            margin-top: 8px;
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 25px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 12px;
            color: #718096;
        }

        .empty-state p {
            font-size: 1.05em;
            line-height: 1.6;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 35px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 28px 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
            animation: pulse 4s ease-in-out infinite;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .stat-number {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.95em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        /* è‡ªè¨‚å½ˆçª—æ¨£å¼ */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .custom-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-message {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“” å¤šæ—¥æ—…éŠå¿ƒå¾—å ±å‘Šç”¢ç”Ÿå™¨</h1>
            <p>è¨˜éŒ„æ¯ä¸€å¤©çš„æ—…ç¨‹,æœ€å¾Œç”Ÿæˆå®Œæ•´çš„æ—…éŠå ±å‘Š!</p>
        </div>

        <div class="content">
            <div class="api-section">
                <h3>ğŸ”‘ Google AI Studio API Key</h3>
                <input type="password" id="apiKey" placeholder="è«‹è¼¸å…¥ä½ çš„ Google AI Studio API Key">
                <div class="hint">
                    å–å¾—æ–¹å¼: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="add">â• æ–°å¢æ¯æ—¥è¨˜éŒ„</button>
                <button class="tab" data-tab="view">ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„</button>
                <button class="tab" data-tab="report">ğŸ“Š ç”Ÿæˆå®Œæ•´å ±å‘Š</button>
            </div>

            <!-- æ–°å¢è¨˜éŒ„é é¢ -->
            <div id="addTab" class="tab-content active">
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="exportDraftBtn" style="flex: 1; min-width: 150px; padding: 12px; font-size: 0.95em;">
                        ğŸ“¤ åŒ¯å‡ºç•¶å‰è‰ç¨¿
                    </button>
                    <button class="btn btn-success" id="importDraftBtn" style="flex: 1; min-width: 150px; padding: 12px; font-size: 0.95em;">
                        ğŸ“¥ åŒ¯å…¥è‰ç¨¿
                    </button>
                    <input type="file" id="importDraftFile" accept=".json" style="display: none;">
                </div>

                <form id="dayForm">
                    <div class="form-group">
                        <label for="tripName">ğŸ¯ æ—…ç¨‹åç¨±</label>
                        <input type="text" id="tripName" placeholder="ä¾‹å¦‚: äº¬éƒ½äº”æ—¥éŠ" required>
                        <div class="hint">ç¬¬ä¸€æ¬¡å¡«å¯«å¾Œæœƒè‡ªå‹•è¨˜ä½</div>
                    </div>

                    <div class="form-group">
                        <label for="dayNumber">ğŸ“… ç¬¬å¹¾å¤©</label>
                        <input type="number" id="dayNumber" min="1" placeholder="ä¾‹å¦‚: 1" required>
                    </div>

                    <div class="form-group">
                        <label for="date">ğŸ“† æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label for="location">ğŸ“ ä¸»è¦åœ°é»</label>
                        <input type="text" id="location" placeholder="ä¾‹å¦‚: äº¬éƒ½å¸‚å€" required>
                    </div>

                    <div class="form-group">
                        <label for="attractions">ğŸ›ï¸ æ™¯é» (ç”¨é€—è™Ÿåˆ†éš”)</label>
                        <input type="text" id="attractions" placeholder="ä¾‹å¦‚: æ¸…æ°´å¯º, é‡‘é–£å¯º, åµå±±" required>
                    </div>

                    <div class="form-group">
                        <label for="notes">ğŸ’­ ä»Šæ—¥å¿ƒå¾—</label>
                        <textarea id="notes" placeholder="æè¿°ä»Šå¤©çš„æ„Ÿå—ã€å°è±¡æ·±åˆ»çš„äº‹..." required></textarea>
                        <button type="button" class="btn btn-success" id="aiGenerateBtn" style="margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            âœ¨ AI æ ¹æ“šç…§ç‰‡ç”Ÿæˆå¿ƒå¾—
                        </button>
                        <div style="font-size: 0.9em; color: #666; margin-top: 8px;">
                            ğŸ’¡ ä¸Šå‚³ç…§ç‰‡å¾Œ,é»æ­¤æŒ‰éˆ•è®“ AI è‡ªå‹•åˆ†æç…§ç‰‡ä¸¦ç”Ÿæˆå¿ƒå¾—
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ğŸ“· ä»Šæ—¥ç…§ç‰‡</label>
                        <div class="image-upload" id="imageUpload">
                            <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“¸</div>
                            <p>é»æ“Šæˆ–æ‹–æ›³ç…§ç‰‡ä¸Šå‚³</p>
                            <p style="font-size: 0.9em; color: #888; margin-top: 8px;">ä½¿ç”¨ IndexedDB å„²å­˜,å¯ä¸Šå‚³æ›´å¤šç…§ç‰‡</p>
                            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="image-preview" id="imagePreview"></div>
                        <div class="hint">ğŸ’¡ ç…§ç‰‡æœƒè‡ªå‹•å£“ç¸®,å»ºè­°æ¯å¤© 3-8 å¼µ</div>
                    </div>

                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1em;">
                        âœ… å„²å­˜é€™ä¸€å¤©çš„è¨˜éŒ„
                    </button>
                </form>
            </div>

            <!-- æŸ¥çœ‹è¨˜éŒ„é é¢ -->
            <div id="viewTab" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="exportBtn" style="flex: 1; min-width: 150px;">
                        ğŸ“¤ åŒ¯å‡ºæ‰€æœ‰è¨˜éŒ„
                    </button>
                    <button class="btn btn-success" id="importBtn" style="flex: 1; min-width: 150px;">
                        ğŸ“¥ åŒ¯å…¥è¨˜éŒ„
                    </button>
                    <button class="btn btn-delete" id="clearAllBtn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
                <div id="daysList"></div>
            </div>

            <!-- ç”Ÿæˆå ±å‘Šé é¢ -->
            <div id="reportTab" class="tab-content">
                <div class="stats" id="stats"></div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="generateReportBtn" class="btn btn-primary" style="flex: 2; min-width: 200px; padding: 18px; font-size: 1.2em;">
                        ğŸ“ ç”Ÿæˆå®Œæ•´æ—…éŠå ±å‘Š
                    </button>
                    <button id="testApiBtn" class="btn btn-success" style="flex: 1; min-width: 150px;">
                        ğŸ” æ¸¬è©¦ API Key
                    </button>
                </div>
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <p style="margin: 0; color: #856404; font-size: 0.95em;">
                        ğŸ’¡ <strong>æç¤º:</strong> ä½¿ç”¨ gemini-2.5-flash æ¨¡å‹ç”Ÿæˆå ±å‘Šã€‚<br>
                        â€¢ å ±å‘ŠæœƒåŸºæ–¼ä½ çš„å¿ƒå¾—ç”Ÿæˆ<br>
                        â€¢ å¯é¸æ“‡æ˜¯å¦åˆ†æç…§ç‰‡(åˆ†æç…§ç‰‡æœƒæ¶ˆè€—æ›´å¤š API é…é¡)
                    </p>
                    <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9em;">
                        âš ï¸ å¦‚æœå‡ºç¾ã€Œé…é¡è¶…éé™åˆ¶ã€éŒ¯èª¤:<br>
                        <strong>è§£æ±ºæ–¹æ³•:</strong><br>
                        1. å–æ¶ˆå‹¾é¸ã€Œåˆ†æç…§ç‰‡ã€é¸é …<br>
                        2. ç­‰å¾…é…é¡é‡ç½®(é€šå¸¸æ˜¯æ¯å¤©æˆ–æ¯å°æ™‚)<br>
                        3. æˆ–ä½¿ç”¨æ–°çš„ API Key
                    </p>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="analyzePhotos" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333;">
                            ğŸ“¸ åˆ†æç…§ç‰‡ (æœƒä½¿ç”¨æ›´å¤š API é…é¡,ä½†å ±å‘Šæ›´è±å¯Œ)
                        </span>
                    </label>
                    <p style="margin: 10px 0 0 0; color: #666; font-size: 0.9em; padding-left: 28px;">
                        å‹¾é¸: åˆ†ææ¯å¤©æœ€å¤š 3 å¼µç…§ç‰‡,ç”Ÿæˆæ™‚é–“ç´„ 30-60 ç§’<br>
                        ä¸å‹¾é¸: åƒ…åŸºæ–¼æ–‡å­—å¿ƒå¾—ç”Ÿæˆ,é€Ÿåº¦å¿«,é…é¡æ¶ˆè€—å°‘
                    </p>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†ææ‰€æœ‰ç…§ç‰‡å’Œç”Ÿæˆå®Œæ•´å ±å‘Š...</p>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="result-section" id="resultSection">
                    <h2 style="margin-bottom: 20px; color: #667eea;">âœ¨ ä½ çš„æ—…éŠå ±å‘Š</h2>
                    
                    <!-- å¯ç·¨è¼¯çš„æ–‡å­—å€åŸŸ -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                            ğŸ“ å ±å‘Šå…§å®¹ (å¯ç·¨è¼¯)
                        </label>
                        <textarea id="editableContent" rows="20" style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; line-height: 1.8; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <!-- åŸå§‹å ±å‘Šå…§å®¹ (éš±è—) -->
                    <div class="result-content" id="resultContent" style="display: none;"></div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <button class="btn btn-primary" id="regenerateBtn">
                            ğŸ”„ é‡æ–°ç”Ÿæˆå ±å‘Š
                        </button>
                        <button class="btn btn-primary" id="copyBtn">
                            ğŸ“‹ è¤‡è£½å ±å‘Š
                        </button>
                        <button class="btn btn-success" id="exportReportBtn">
                            ğŸ’¾ ä¸‹è¼‰å ±å‘Š
                        </button>
                    </div>

                    <div style="padding: 15px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #2196f3;">
                        <p style="margin: 0; color: #1565c0; font-size: 0.95em;">
                            ğŸ’¡ <strong>æç¤º:</strong><br>
                            â€¢ å¯ä»¥ç›´æ¥åœ¨æ–‡å­—æ¡†ä¸­ç·¨è¼¯å…§å®¹<br>
                            â€¢ é»ã€ŒğŸ”„ é‡æ–°ç”Ÿæˆã€æœƒç”¨æœ€æ–°çš„è¨˜éŒ„é‡æ–°ç”Ÿæˆå ±å‘Š<br>
                            â€¢ ç·¨è¼¯å¾Œçš„å…§å®¹æœƒåœ¨è¤‡è£½å’Œä¸‹è¼‰æ™‚ä½¿ç”¨
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªè¨‚å½ˆçª— -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        // è‡ªè¨‚å½ˆçª—å‡½æ•¸æ›¿ä»£ alert å’Œ confirm
        function showAlert(message, title = 'æç¤º') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalButtons = document.getElementById('modalButtons');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalButtons.innerHTML = '<button class="modal-btn modal-btn-primary" onclick="closeModal()">ç¢ºå®š</button>';
                
                modal.classList.add('active');
                
                window.closeModal = () => {
                    modal.classList.remove('active');
                    resolve(true);
                };
            });
        }

        function showConfirm(message, title = 'ç¢ºèª') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalButtons = document.getElementById('modalButtons');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalButtons.innerHTML = `
                    <button class="modal-btn modal-btn-secondary" onclick="closeModalWithResult(false)">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-danger" onclick="closeModalWithResult(true)">ç¢ºå®š</button>
                `;
                
                modal.classList.add('active');
                
                window.closeModalWithResult = (result) => {
                    modal.classList.remove('active');
                    resolve(result);
                };
            });
        }

        let uploadedImages = [];
        let travelDays = [];
        let db;

        // åˆå§‹åŒ– IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TravelDiaryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('days')) {
                        db.createObjectStore('days', { keyPath: 'id' });
                    }
                };
            });
        }

        // å¾ IndexedDB è®€å–æ‰€æœ‰è¨˜éŒ„
        function loadDays() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['days'], 'readonly');
                const store = transaction.objectStore('days');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    travelDays = request.result.sort((a, b) => a.dayNumber - b.dayNumber);
                    resolve(travelDays);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // å„²å­˜è¨˜éŒ„åˆ° IndexedDB
        function saveDayToDB(dayData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['days'], 'readwrite');
                const store = transaction.objectStore('days');
                const request = store.add(dayData);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // åˆªé™¤è¨˜éŒ„
        function deleteDayFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['days'], 'readwrite');
                const store = transaction.objectStore('days');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // API Key è™•ç†
        const apiKeyInput = document.getElementById('apiKey');
        if (localStorage.getItem('gemini_api_key')) {
            apiKeyInput.value = localStorage.getItem('gemini_api_key');
        }
        apiKeyInput.addEventListener('change', () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
        });

        // Tab åˆ‡æ›
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                if (tabName === 'view') {
                    renderDaysList();
                } else if (tabName === 'report') {
                    renderStats();
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„å ±å‘Š
                    const savedReport = localStorage.getItem('savedReport');
                    if (savedReport && document.getElementById('editableContent').value === '') {
                        document.getElementById('editableContent').value = savedReport;
                        document.getElementById('resultContent').textContent = savedReport;
                        document.getElementById('resultSection').classList.add('active');
                    }
                }
            });
        });

        // åœ–ç‰‡ä¸Šå‚³
        const imageUpload = document.getElementById('imageUpload');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');

        // è‡ªå‹•å„²å­˜è¡¨å–®å…§å®¹
        function saveFormDraft() {
            const draft = {
                tripName: document.getElementById('tripName').value,
                dayNumber: document.getElementById('dayNumber').value,
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                attractions: document.getElementById('attractions').value,
                notes: document.getElementById('notes').value,
                images: uploadedImages
            };
            localStorage.setItem('formDraft', JSON.stringify(draft));
        }

        // è¼‰å…¥è¡¨å–®æš«å­˜
        function loadFormDraft() {
            const draft = localStorage.getItem('formDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    if (data.tripName) document.getElementById('tripName').value = data.tripName;
                    if (data.dayNumber) document.getElementById('dayNumber').value = data.dayNumber;
                    if (data.date) document.getElementById('date').value = data.date;
                    if (data.location) document.getElementById('location').value = data.location;
                    if (data.attractions) document.getElementById('attractions').value = data.attractions;
                    if (data.notes) document.getElementById('notes').value = data.notes;
                    if (data.images && data.images.length > 0) {
                        uploadedImages = data.images;
                        displayPreview();
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æš«å­˜å¤±æ•—:', error);
                }
            }
        }

        // ç›£è½è¡¨å–®è®ŠåŒ–,è‡ªå‹•å„²å­˜
        ['tripName', 'dayNumber', 'date', 'location', 'attractions', 'notes'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveFormDraft);
            document.getElementById(id).addEventListener('change', saveFormDraft);
        });

        imageUpload.addEventListener('click', () => imageInput.click());
        
        imageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUpload.style.background = '#e8ebff';
        });
        
        imageUpload.addEventListener('dragleave', () => {
            imageUpload.style.background = '#f8f9ff';
        });
        
        imageUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUpload.style.background = '#f8f9ff';
            handleFiles(e.dataTransfer.files);
        });

        imageInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    // é¡¯ç¤º loading æç¤º
                    if (uploadedImages.length === 0) {
                        imagePreview.innerHTML = '<div style="color: #667eea; padding: 10px;">ğŸ“¸ è™•ç†ç…§ç‰‡ä¸­...</div>';
                        imagePreview.classList.add('active');
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // å£“ç¸®åœ–ç‰‡
                        compressImage(e.target.result, (compressedImage) => {
                            uploadedImages.push(compressedImage);
                            displayPreview();
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function compressImage(base64, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // æ”¹æˆæ›´å°çš„å°ºå¯¸,åŠ å¿«è™•ç†é€Ÿåº¦
                const maxWidth = 600;
                const maxHeight = 600;
                let width = img.width;
                let height = img.height;
                
                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // é™ä½å“è³ªåˆ° 0.4,æ¸›å°‘æª”æ¡ˆå¤§å°
                callback(canvas.toDataURL('image/jpeg', 0.4));
            };
            img.onerror = function() {
                console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—');
                callback(null);
            };
            img.src = base64;
        }

        function displayPreview() {
            imagePreview.innerHTML = '';
            
            if (uploadedImages.length > 0) {
                // é¡¯ç¤ºç…§ç‰‡æ•¸é‡
                const countDiv = document.createElement('div');
                countDiv.style.cssText = 'width: 100%; color: #667eea; font-weight: 600; margin-bottom: 10px;';
                countDiv.textContent = `å·²ä¸Šå‚³ ${uploadedImages.length} å¼µç…§ç‰‡`;
                imagePreview.appendChild(countDiv);
            }
            
            uploadedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${img}" alt="Preview" loading="lazy">
                    <button class="remove-image" onclick="removeImage(${index})" type="button">Ã—</button>
                `;
                imagePreview.appendChild(div);
            });
            imagePreview.classList.add('active');
            
            // ç…§ç‰‡è®Šæ›´æ™‚è‡ªå‹•å„²å­˜
            saveFormDraft();
        }

        window.removeImage = function(index) {
            uploadedImages.splice(index, 1);
            if (uploadedImages.length === 0) {
                imagePreview.classList.remove('active');
            }
            displayPreview();
        };

        // å„²å­˜æ¯æ—¥è¨˜éŒ„
        document.getElementById('dayForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tripName = document.getElementById('tripName').value;
            const dayNumber = parseInt(document.getElementById('dayNumber').value);
            const date = document.getElementById('date').value;
            const location = document.getElementById('location').value;
            const attractions = document.getElementById('attractions').value;
            const notes = document.getElementById('notes').value;

            const dayData = {
                id: Date.now(),
                tripName: tripName,
                dayNumber: dayNumber,
                date: date,
                location: location,
                attractions: attractions,
                notes: notes,
                images: [...uploadedImages]
            };

            try {
                await saveDayToDB(dayData);
                await loadDays();
                await showAlert('âœ… ç¬¬ ' + dayNumber + ' å¤©çš„è¨˜éŒ„å·²å„²å­˜!');
                
                // æ¸…ç©ºè¡¨å–®,ä½†ä¿ç•™ tripName
                document.getElementById('dayNumber').value = dayNumber + 1;
                document.getElementById('date').value = '';
                document.getElementById('location').value = '';
                document.getElementById('attractions').value = '';
                document.getElementById('notes').value = '';
                uploadedImages = [];
                imagePreview.classList.remove('active');
                imagePreview.innerHTML = '';
                
                // å„²å­˜æ–°çš„è¡¨å–®ç‹€æ…‹
                saveFormDraft();
            } catch (error) {
                await showAlert('âŒ å„²å­˜å¤±æ•—: ' + error.message);
            }
        });

        // æ¸²æŸ“å¤©æ•¸åˆ—è¡¨
        function renderDaysList() {
            const container = document.getElementById('daysList');
            
            if (travelDays.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <h3>é‚„æ²’æœ‰è¨˜éŒ„</h3>
                        <p>è«‹å…ˆåˆ°ã€Œæ–°å¢æ¯æ—¥è¨˜éŒ„ã€é é¢æ·»åŠ ä½ çš„æ—…ç¨‹è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="day-list">' + travelDays.map(day => `
                <div class="day-card">
                    <div class="day-card-header">
                        <h3>Day ${day.dayNumber} - ${day.location}</h3>
                        <button type="button" class="btn-delete" onclick="deleteDay(${day.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                    <div class="day-card-content">
                        <p><strong>ğŸ“… æ—¥æœŸ:</strong> ${day.date}</p>
                        <p><strong>ğŸ›ï¸ æ™¯é»:</strong> ${day.attractions}</p>
                        <p><strong>ğŸ’­ å¿ƒå¾—:</strong> ${day.notes}</p>
                        ${day.images.length > 0 ? `
                            <div class="day-card-images">
                                ${day.images.map(img => `<img src="${img}" alt="ç…§ç‰‡">`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('') + '</div>';
        }

        window.deleteDay = async function(id) {
            if (await showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©çš„è¨˜éŒ„å—?')) {
                try {
                    await deleteDayFromDB(id);
                    await loadDays();
                    renderDaysList();
                    renderStats();
                } catch (error) {
                    await showAlert('åˆªé™¤å¤±æ•—: ' + error.message);
                }
            }
        };

        // åŒ¯å‡ºåŠŸèƒ½
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                if (travelDays.length === 0) {
                    await showAlert('âš ï¸ æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡º!');
                    return;
                }

                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    tripName: travelDays[0]?.tripName || 'æ—…ç¨‹',
                    totalDays: travelDays.length,
                    days: travelDays
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ—…éŠè¨˜éŒ„_${exportData.tripName}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                await showAlert('âœ… åŒ¯å‡ºæˆåŠŸ! æª”æ¡ˆå·²ä¸‹è¼‰åˆ°æ‚¨çš„è£ç½®');
            } catch (error) {
                await showAlert('âŒ åŒ¯å‡ºå¤±æ•—: ' + error.message);
            }
        });

        // åŒ¯å…¥åŠŸèƒ½
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                // é©—è­‰è³‡æ–™æ ¼å¼
                if (!importData.days || !Array.isArray(importData.days)) {
                    throw new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                }

                // è©¢å•æ˜¯å¦è¦†è“‹ç¾æœ‰è³‡æ–™
                let shouldMerge = false;
                if (travelDays.length > 0) {
                    const choice = await showConfirm(
                        `ç›®å‰æœ‰ ${travelDays.length} å¤©çš„è¨˜éŒ„\n` +
                        `åŒ¯å…¥æª”æ¡ˆæœ‰ ${importData.days.length} å¤©çš„è¨˜éŒ„\n\n` +
                        `æŒ‰ã€Œç¢ºå®šã€= åˆä½µè³‡æ–™\n` +
                        `æŒ‰ã€Œå–æ¶ˆã€= è¦†è“‹ç¾æœ‰è³‡æ–™`
                    );
                    shouldMerge = choice;

                    if (!shouldMerge) {
                        // æ¸…ç©ºç¾æœ‰è³‡æ–™
                        const transaction = db.transaction(['days'], 'readwrite');
                        const store = transaction.objectStore('days');
                        await store.clear();
                    }
                }

                // åŒ¯å…¥è³‡æ–™
                let importCount = 0;
                for (const day of importData.days) {
                    // ç”Ÿæˆæ–°çš„ ID é¿å…è¡çª
                    const newDay = {
                        ...day,
                        id: Date.now() + importCount
                    };
                    await saveDayToDB(newDay);
                    importCount++;
                }

                await loadDays();
                renderDaysList();
                renderStats();

                // è‡ªå‹•å¡«å…¥æ—…ç¨‹åç¨±
                if (travelDays.length > 0) {
                    document.getElementById('tripName').value = travelDays[0].tripName;
                    document.getElementById('dayNumber').value = travelDays.length + 1;
                }

                alert(`âœ… åŒ¯å…¥æˆåŠŸ! å·²åŒ¯å…¥ ${importCount} å¤©çš„è¨˜éŒ„`);
                
                // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
                e.target.value = '';
            } catch (error) {
                await showAlert('âŒ åŒ¯å…¥å¤±æ•—: ' + error.message + '\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º');
                e.target.value = '';
            }
        });

        // æ¸²æŸ“çµ±è¨ˆ
        function renderStats() {
            const container = document.getElementById('stats');
            const totalDays = travelDays.length;
            const totalPhotos = travelDays.reduce((sum, day) => sum + day.images.length, 0);
            const locations = [...new Set(travelDays.map(d => d.location))].length;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalDays}</div>
                    <div class="stat-label">è¨˜éŒ„å¤©æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalPhotos}</div>
                    <div class="stat-label">ç…§ç‰‡æ•¸é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${locations}</div>
                    <div class="stat-label">åœ°é»æ•¸é‡</div>
                </div>
            `;
        }

        // ç”Ÿæˆå®Œæ•´å ±å‘Š
        document.getElementById('generateReportBtn').addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                await showAlert('è«‹å…ˆè¼¸å…¥ API Key!');
                return;
            }

            if (travelDays.length === 0) {
                await showAlert('è«‹å…ˆæ·»åŠ è‡³å°‘ä¸€å¤©çš„è¨˜éŒ„!');
                return;
            }

            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const resultSection = document.getElementById('resultSection');
            
            loading.classList.add('active');
            errorMessage.classList.remove('active');
            resultSection.classList.remove('active');
            
            const shouldAnalyzePhotos = document.getElementById('analyzePhotos').checked;

            try {
                let daysWithDescriptions = [];
                
                if (shouldAnalyzePhotos) {
                    // åˆ†ææ‰€æœ‰ç…§ç‰‡
                    loading.querySelector('p').textContent = 'æ­£åœ¨åˆ†æç…§ç‰‡...';
                    let analyzedDays = 0;
                    
                    for (const day of travelDays) {
                        if (day.images && day.images.length > 0) {
                            loading.querySelector('p').textContent = `æ­£åœ¨åˆ†æç¬¬ ${day.dayNumber} å¤©çš„ç…§ç‰‡... (${analyzedDays + 1}/${travelDays.length})`;
                            
                            const imageDescriptions = [];
                            // åˆ†æå‰ 3 å¼µç…§ç‰‡
                            const imagesToAnalyze = day.images.slice(0, 3);
                            
                            for (let i = 0; i < imagesToAnalyze.length; i++) {
                                try {
                                    const desc = await analyzeImage(imagesToAnalyze[i], apiKey);
                                    imageDescriptions.push(desc);
                                    
                                    // å»¶é²é¿å… API é™æµ
                                    if (i < imagesToAnalyze.length - 1) {
                                        await new Promise(resolve => setTimeout(resolve, 800));
                                    }
                                } catch (error) {
                                    console.error('ç…§ç‰‡åˆ†æå¤±æ•—:', error);
                                    imageDescriptions.push('ç…§ç‰‡');
                                }
                            }
                            
                            daysWithDescriptions.push({
                                ...day,
                                imageDescriptions
                            });
                        } else {
                            // æ²’æœ‰ç…§ç‰‡çš„æ—¥å­
                            daysWithDescriptions.push({
                                ...day,
                                imageDescriptions: []
                            });
                        }
                        
                        analyzedDays++;
                    }
                } else {
                    // ä¸åˆ†æç…§ç‰‡,ç›´æ¥ä½¿ç”¨æ–‡å­—è³‡è¨Š
                    loading.querySelector('p').textContent = 'æ­£åœ¨ç”Ÿæˆæ—…éŠå ±å‘Š...';
                    daysWithDescriptions = travelDays.map(day => ({
                        ...day,
                        imageDescriptions: []
                    }));
                }

                // ç”Ÿæˆå®Œæ•´å ±å‘Š
                loading.querySelector('p').textContent = 'æ­£åœ¨ç”Ÿæˆæ—…éŠå ±å‘Š...';
                const report = await generateReport(daysWithDescriptions, apiKey);
                
                // å­˜å…¥éš±è—çš„ div (åŸå§‹å ±å‘Š)
                document.getElementById('resultContent').textContent = report;
                // åŒæ™‚é¡¯ç¤ºåœ¨å¯ç·¨è¼¯çš„ textarea
                document.getElementById('editableContent').value = report;
                
                // æš«å­˜å ±å‘Šå…§å®¹
                localStorage.setItem('savedReport', report);
                
                resultSection.classList.add('active');
            } catch (error) {
                console.error('ç”ŸæˆéŒ¯èª¤:', error);
                let errorMsg = 'ç”Ÿæˆå¤±æ•—: ' + error.message;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    errorMsg += '\n\nğŸ’¡ å»ºè­°:\n';
                    errorMsg += '1. æª¢æŸ¥ç¶²è·¯é€£ç·š\n';
                    errorMsg += '2. åˆ‡æ›åˆ° WiFi ç¶²è·¯\n';
                    errorMsg += '3. ç¨å¾Œå†è©¦';
                }
                
                errorMessage.textContent = errorMsg;
                errorMessage.classList.add('active');
            } finally {
                loading.classList.remove('active');
            }
        });

        async function analyzeImage(imageData, apiKey) {
            const base64Data = imageData.split(',')[1];
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­æè¿°é€™å¼µç…§ç‰‡,20å­—ä»¥å…§ã€‚' },
                                { inline_data: { mime_type: 'image/jpeg', data: base64Data }}
                            ]
                        }],
                        generationConfig: { 
                            temperature: 0.7, 
                            maxOutputTokens: 100
                        }
                    })
                });

                if (!response.ok) {
                    console.error('åœ–ç‰‡åˆ†æå¤±æ•—:', response.status);
                    return 'ç¾éº—çš„ç…§ç‰‡'; // å¤±æ•—å°±ç”¨é è¨­æè¿°
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'ç²¾å½©çš„ç…§ç‰‡';
            } catch (error) {
                console.error('åœ–ç‰‡åˆ†æéŒ¯èª¤:', error.message);
                return 'æ—…éŠç…§ç‰‡'; // å‡ºéŒ¯å°±ç”¨é è¨­æè¿°
            }
        }

        async function generateReport(days, apiKey) {
            const tripName = days[0].tripName;
            
            let prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤šæ—¥æ—…éŠè¨˜éŒ„,ç”Ÿæˆä¸€ç¯‡å®Œæ•´çš„æ—…éŠå ±å‘Š:

æ—…ç¨‹åç¨±: ${tripName}
ç¸½å…±å¤©æ•¸: ${days.length} å¤©

æ¯æ—¥è©³ç´°è¨˜éŒ„:\n`;

            days.forEach(day => {
                prompt += `\n=== Day ${day.dayNumber} (${day.date}) ===
åœ°é»: ${day.location}
æ™¯é»: ${day.attractions}`;
                
                // å¦‚æœæœ‰ç…§ç‰‡æè¿°,åŠ å…¥æç¤º
                if (day.imageDescriptions && day.imageDescriptions.length > 0) {
                    prompt += `\nç…§ç‰‡å…§å®¹: ${day.imageDescriptions.join('ã€')}`;
                }
                
                prompt += `\næˆ‘çš„å¿ƒå¾—:
${day.notes}
`;
            });

            prompt += `\n\nã€é‡è¦è¦æ±‚ã€‘:
1. ç”¨ç¬¬ä¸€äººç¨±æ’°å¯«,èªæ°£è¼•é¬†è‡ªç„¶
2. å ±å‘Šçµæ§‹:
   - é–‹é ­: ç°¡çŸ­ä»‹ç´¹é€™æ¬¡æ—…è¡Œ(1-2å¥è©±)
   - å…§å®¹: æŒ‰å¤©æ•¸é †åºæè¿°æ¯å¤©è¡Œç¨‹
   - çµå°¾: ç¸½çµæ•´é«”æ„Ÿæƒ³(1-2å¥è©±)

3. ã€æœ€é‡è¦ã€‘æ¯å¤©çš„å…§å®¹å¿…é ˆ:
   - å®Œå…¨ä¾ç…§ã€Œæˆ‘çš„å¿ƒå¾—ã€çš„å…§å®¹ä¾†å¯«
   - å¦‚æœæœ‰ã€Œç…§ç‰‡å…§å®¹ã€,å¯ä»¥é©ç•¶èå…¥ç…§ç‰‡ä¸­çœ‹åˆ°çš„å ´æ™¯æˆ–ç‰©å“
   - ä½†ä¸è¦æ·»åŠ æˆ‘å¿ƒå¾—ä¸­æ²’æœ‰æåˆ°çš„æ„Ÿå—æˆ–è©•åƒ¹
   - ä¸è¦è‡ªå·±ç·¨é€ æˆ–æƒ³åƒä»»ä½•å…§å®¹
   - å¦‚æœå¿ƒå¾—å¾ˆç°¡çŸ­,å ±å‘Šçš„è©²å¤©å…§å®¹ä¹Ÿè¦ç°¡çŸ­
   - å¦‚æœå¿ƒå¾—å¾ˆè©³ç´°,å ±å‘Šçš„è©²å¤©å…§å®¹ä¹Ÿè¦è©³ç´°
   - åªæ•´ç†å’Œæ½¤é£¾æˆ‘å¯«çš„å¿ƒå¾—,ç…§ç‰‡è³‡è¨Šåªæ˜¯è¼”åŠ©åƒè€ƒ

4. ç…§ç‰‡å…§å®¹çš„ä½¿ç”¨åŸå‰‡:
   - åªç”¨ä¾†è£œå……å ´æ™¯æè¿°(ä¾‹å¦‚:å¤©æ°£ã€ç’°å¢ƒã€å»ºç¯‰å¤–è§€)
   - ä¸è¦ç”¨ç…§ç‰‡å…§å®¹ä¾†å‰µé€ æˆ‘æ²’èªªéçš„æ„Ÿå—
   - å¦‚æœå¿ƒå¾—å·²ç¶“å¾ˆå®Œæ•´,ç…§ç‰‡è³‡è¨Šå¯ä»¥ä¸ç”¨

5. æ•´é«”é¢¨æ ¼:
   - ä¿æŒæˆ‘åŸæœ¬å¿ƒå¾—çš„èªæ°£å’Œæ„Ÿå—
   - ä½¿ç”¨ç¹é«”ä¸­æ–‡
   - é©ç•¶åˆ†æ®µ,æ˜“æ–¼é–±è®€
   
è«‹åš´æ ¼éµå®ˆä»¥ä¸Šè¦æ±‚,ç‰¹åˆ¥æ˜¯ç¬¬3é»,ä¸è¦è‡ªå·±å‰µä½œä»»ä½•å…§å®¹ã€‚`;

            try {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent('gemini-2.5-flash')}:generateContent`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey,
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    
                    let errorMsg = '';
                    if (response.status === 400) {
                        errorMsg = 'âŒ API Key éŒ¯èª¤æˆ–è«‹æ±‚æ ¼å¼ä¸æ­£ç¢º';
                    } else if (response.status === 403) {
                        errorMsg = 'âŒ API Key ç„¡æ•ˆæˆ–å·²éæœŸ';
                    } else if (response.status === 429) {
                        errorMsg = 'âš ï¸ API è«‹æ±‚æ¬¡æ•¸è¶…éé™åˆ¶';
                    } else if (response.status >= 500) {
                        errorMsg = 'âš ï¸ Google ä¼ºæœå™¨éŒ¯èª¤';
                    } else {
                        errorMsg = `API éŒ¯èª¤ (${response.status})`;
                    }
                    
                    if (errorData?.error?.message) {
                        errorMsg += '\n\n' + errorData.error.message;
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('API æœªè¿”å›æœ‰æ•ˆçµæœ');
                }
                
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('ç”Ÿæˆå ±å‘ŠéŒ¯èª¤:', error);
                
                // ç¶²è·¯éŒ¯èª¤
                if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                    throw new Error('ğŸŒ ç¶²è·¯é€£ç·šå¤±æ•—\n\nå¯èƒ½åŸå› :\nâ€¢ ç¶²è·¯ä¸ç©©å®š\nâ€¢ é˜²ç«ç‰†é˜»æ“‹\nâ€¢ VPN å•é¡Œ\nâ€¢ ISP é™åˆ¶\n\nå»ºè­°:\nâ€¢ åˆ‡æ›ç¶²è·¯(WiFi/è¡Œå‹•æ•¸æ“š)\nâ€¢ é—œé–‰ VPN\nâ€¢ æª¢æŸ¥é˜²ç«ç‰†è¨­å®š');
                }
                
                throw error;
            }
        }

        // é‡æ–°ç”Ÿæˆå ±å‘Š
        document.getElementById('regenerateBtn').addEventListener('click', async () => {
            // ç¢ºèªæ˜¯å¦è¦é‡æ–°ç”Ÿæˆ
            const shouldRegenerate = await showConfirm(
                'ğŸ”„ ç¢ºå®šè¦é‡æ–°ç”Ÿæˆå ±å‘Šå—?\n\nç›®å‰ç·¨è¼¯çš„å…§å®¹å°‡æœƒè¢«è¦†è“‹ã€‚\n\nå»ºè­°å…ˆè¤‡è£½æˆ–ä¸‹è¼‰ç›®å‰çš„å…§å®¹ã€‚'
            );
            
            if (!shouldRegenerate) {
                return;
            }
            
            // è§¸ç™¼ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•
            document.getElementById('generateReportBtn').click();
        });

        // ç›£è½å ±å‘Šç·¨è¼¯,å¯¦æ™‚æš«å­˜
        document.getElementById('editableContent').addEventListener('input', () => {
            const content = document.getElementById('editableContent').value;
            localStorage.setItem('savedReport', content);
        });

        // è¤‡è£½åŠŸèƒ½ (ä½¿ç”¨å¯ç·¨è¼¯çš„å…§å®¹)
        document.getElementById('copyBtn').addEventListener('click', async () => {
            const text = document.getElementById('editableContent').value;
            try {
                await navigator.clipboard.writeText(text);
                await showAlert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!');
            } catch (error) {
                await showAlert('âŒ è¤‡è£½å¤±æ•—: ' + error.message);
            }
        });

        // ä¸‹è¼‰å ±å‘ŠåŠŸèƒ½ (ä½¿ç”¨å¯ç·¨è¼¯çš„å…§å®¹)
        document.getElementById('exportReportBtn').addEventListener('click', async () => {
            const text = document.getElementById('editableContent').value;
            const tripName = travelDays[0]?.tripName || 'æ—…éŠå ±å‘Š';
            const date = new Date().toISOString().split('T')[0];
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tripName}_å ±å‘Š_${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            await showAlert('âœ… å ±å‘Šå·²ä¸‹è¼‰!');
        });

        // æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„åŠŸèƒ½
        document.getElementById('clearAllBtn').addEventListener('click', async () => {
            if (!await showConfirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„å—?\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸ!å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚')) {
                return;
            }

            if (!await showConfirm('ğŸ”´ æœ€å¾Œç¢ºèª:\nçœŸçš„è¦åˆªé™¤æ‰€æœ‰ ' + travelDays.length + ' å¤©çš„è¨˜éŒ„å—?')) {
                return;
            }

            try {
                // æ¸…ç©º IndexedDB
                const transaction = db.transaction(['days'], 'readwrite');
                const store = transaction.objectStore('days');
                await store.clear();

                // é‡æ–°è¼‰å…¥
                await loadDays();
                renderDaysList();
                renderStats();

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('tripName').value = '';
                document.getElementById('dayNumber').value = '1';
                document.getElementById('date').value = '';
                document.getElementById('location').value = '';
                document.getElementById('attractions').value = '';
                document.getElementById('notes').value = '';

                // æ¸…ç©ºè¡¨å–®æš«å­˜
                localStorage.removeItem('formDraft');
                
                // æ¸…é™¤å ±å‘Šæš«å­˜
                localStorage.removeItem('savedReport');
                document.getElementById('editableContent').value = '';
                document.getElementById('resultContent').textContent = '';
                document.getElementById('resultSection').classList.remove('active');

                await showAlert('âœ… å·²æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„!');
            } catch (error) {
                await showAlert('âŒ æ¸…ç©ºå¤±æ•—: ' + error.message);
            }
        });

        // åŒ¯å‡ºç•¶å‰è‰ç¨¿
        document.getElementById('exportDraftBtn').addEventListener('click', async () => {
            const draft = {
                tripName: document.getElementById('tripName').value,
                dayNumber: document.getElementById('dayNumber').value,
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                attractions: document.getElementById('attractions').value,
                notes: document.getElementById('notes').value,
                images: uploadedImages,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            // æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹
            if (!draft.tripName && !draft.location && !draft.notes) {
                await showAlert('âš ï¸ ç›®å‰æ²’æœ‰å¯ä»¥åŒ¯å‡ºçš„è‰ç¨¿å…§å®¹');
                return;
            }

            const dataStr = JSON.stringify(draft, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const filename = draft.tripName || 'æ—…éŠè‰ç¨¿';
            const day = draft.dayNumber || 'X';
            a.download = `${filename}_Day${day}_è‰ç¨¿_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            await showAlert('âœ… è‰ç¨¿å·²åŒ¯å‡º!');
        });

        // åŒ¯å…¥è‰ç¨¿
        document.getElementById('importDraftBtn').addEventListener('click', async () => {
            // æª¢æŸ¥æ˜¯å¦æœ‰æœªå„²å­˜çš„å…§å®¹
            const hasContent = document.getElementById('tripName').value ||
                              document.getElementById('location').value ||
                              document.getElementById('notes').value ||
                              uploadedImages.length > 0;

            if (hasContent) {
                if (!await showConfirm('âš ï¸ ç›®å‰æœ‰æœªå„²å­˜çš„å…§å®¹\n\nåŒ¯å…¥è‰ç¨¿æœƒè¦†è“‹ç¾æœ‰å…§å®¹,ç¢ºå®šè¦ç¹¼çºŒå—?')) {
                    return;
                }
            }

            document.getElementById('importDraftFile').click();
        });

        document.getElementById('importDraftFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const draft = JSON.parse(text);

                // é©—è­‰æ ¼å¼
                if (typeof draft !== 'object') {
                    throw new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                }

                // å¡«å…¥è¡¨å–®
                if (draft.tripName) document.getElementById('tripName').value = draft.tripName;
                if (draft.dayNumber) document.getElementById('dayNumber').value = draft.dayNumber;
                if (draft.date) document.getElementById('date').value = draft.date;
                if (draft.location) document.getElementById('location').value = draft.location;
                if (draft.attractions) document.getElementById('attractions').value = draft.attractions;
                if (draft.notes) document.getElementById('notes').value = draft.notes;
                
                // è¼‰å…¥ç…§ç‰‡
                if (draft.images && Array.isArray(draft.images)) {
                    uploadedImages = draft.images;
                    displayPreview();
                }

                // å„²å­˜åˆ°æš«å­˜
                saveFormDraft();

                await showAlert('âœ… è‰ç¨¿åŒ¯å…¥æˆåŠŸ!');
                
                // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
                e.target.value = '';
            } catch (error) {
                await showAlert('âŒ åŒ¯å…¥å¤±æ•—: ' + error.message + '\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º');
                e.target.value = '';
            }
        });

        // AI ç”Ÿæˆå¿ƒå¾—åŠŸèƒ½
        document.getElementById('aiGenerateBtn').addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                await showAlert('è«‹å…ˆè¼¸å…¥ API Key!');
                return;
            }

            if (uploadedImages.length === 0) {
                await showAlert('è«‹å…ˆä¸Šå‚³ç…§ç‰‡!');
                return;
            }

            const location = document.getElementById('location').value;
            const attractions = document.getElementById('attractions').value;
            const date = document.getElementById('date').value;

            if (!location || !attractions || !date) {
                await showAlert('è«‹å…ˆå¡«å¯«æ—¥æœŸã€åœ°é»å’Œæ™¯é»!');
                return;
            }

            const btn = document.getElementById('aiGenerateBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ğŸ¤– AI åˆ†æä¸­...';

            try {
                // åˆ†æç…§ç‰‡
                const imageDescriptions = [];
                const maxImages = Math.min(uploadedImages.length, 6); // æœ€å¤šåˆ†æ 6 å¼µ
                
                for (let i = 0; i < maxImages; i++) {
                    btn.textContent = `ğŸ¤– åˆ†æç…§ç‰‡ ${i + 1}/${maxImages}...`;
                    
                    try {
                        const desc = await analyzeImageForNotes(uploadedImages[i], apiKey);
                        imageDescriptions.push(desc);
                        
                        // å»¶é²é¿å… API é™æµ
                        if (i < maxImages - 1) {
                            await new Promise(resolve => setTimeout(resolve, 800));
                        }
                    } catch (error) {
                        console.error('ç…§ç‰‡åˆ†æå¤±æ•—:', error);
                        imageDescriptions.push('ç²¾å½©çš„ç…§ç‰‡');
                    }
                }

                // ç”Ÿæˆå¿ƒå¾—
                btn.textContent = 'âœï¸ ç”Ÿæˆå¿ƒå¾—ä¸­...';
                const notes = await generateNotesFromPhotos(date, location, attractions, imageDescriptions, apiKey);
                
                // å¡«å…¥å¿ƒå¾—æ¬„ä½
                document.getElementById('notes').value = notes;
                
                await showAlert('âœ… AI å¿ƒå¾—ç”ŸæˆæˆåŠŸ!');
            } catch (error) {
                await showAlert('âŒ ç”Ÿæˆå¤±æ•—: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        async function analyzeImageForNotes(imageData, apiKey) {
            const base64Data = imageData.split(',')[1];
            
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent('gemini-2.5-flash')}:generateContent`;
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiKey,
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: 'è«‹ç”¨ç¹é«”ä¸­æ–‡è©³ç´°æè¿°é€™å¼µç…§ç‰‡,åŒ…æ‹¬å ´æ™¯ã€ç‰©é«”ã€æ°›åœã€é¡è‰²ç­‰ã€‚50å­—ä»¥å…§ã€‚' },
                            { inline_data: { mime_type: 'image/jpeg', data: base64Data }}
                        ]
                    }],
                }),
            });

            if (!response.ok) {
                throw new Error('ç…§ç‰‡åˆ†æå¤±æ•—');
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateNotesFromPhotos(date, location, attractions, imageDescriptions, apiKey) {
            const prompt = `è«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šç”Ÿæˆä¸€ç¯‡æ—…éŠå¿ƒå¾—,ç´„250-300å­—:

æ—¥æœŸ: ${date}
åœ°é»: ${location}
æ™¯é»: ${attractions}

ç…§ç‰‡å…§å®¹:
${imageDescriptions.map((desc, i) => `ç…§ç‰‡${i + 1}: ${desc}`).join('\n')}

è¦æ±‚:
1. ç”¨ç¬¬ä¸€äººç¨±,åƒå¯«æ—¥è¨˜ä¸€æ¨£
2. æ ¹æ“šç…§ç‰‡æè¿°æ—…éŠéç¨‹å’Œæ„Ÿå—
3. èå…¥ç…§ç‰‡ä¸­çš„å ´æ™¯å’Œæ°›åœ
4. èªæ°£è¼•é¬†è‡ªç„¶
5. è¦æœ‰å…·é«”çš„æ„Ÿå—
6. ä½¿ç”¨ç¹é«”ä¸­æ–‡
7. ç´„ 250-300 å­—`;

            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent('gemini-2.5-flash')}:generateContent`;
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-goog-api-key': apiKey,
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                }),
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || 'å¿ƒå¾—ç”Ÿæˆå¤±æ•—');
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // æ¸¬è©¦ API Key åŠŸèƒ½
        document.getElementById('testApiBtn').addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                await showAlert('è«‹å…ˆè¼¸å…¥ API Key!');
                return;
            }

            const btn = document.getElementById('testApiBtn');
            const originalText = btn.textContent;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            btn.disabled = true;

            try {
                // å…ˆæ¸¬è©¦åˆ—å‡ºå¯ç”¨çš„æ¨¡å‹
                const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1/models`, {
                    headers: { 'x-goog-api-key': apiKey }
                });
                
                if (listResponse.ok) {
                    const models = await listResponse.json();
                    console.log('å¯ç”¨æ¨¡å‹:', models);
                }

                // æ¸¬è©¦ gemini-2.5-flash æ¨¡å‹
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent('gemini-2.5-flash')}:generateContent`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-goog-api-key': apiKey,
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'ä½ å¥½,è«‹ç”¨ç¹é«”ä¸­æ–‡å›è¦†ã€Œæ¸¬è©¦æˆåŠŸã€' }] }],
                    }),
                });

                let statusInfo = `HTTP ç‹€æ…‹ç¢¼: ${response.status}\n`;
                statusInfo += `ç‹€æ…‹æ–‡å­—: ${response.statusText}\n`;
                statusInfo += `ä½¿ç”¨æ¨¡å‹: gemini-2.5-flash\n\n`;

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    
                    let errorMsg = 'âŒ API Key æ¸¬è©¦å¤±æ•—\n\n';
                    errorMsg += statusInfo;
                    
                    if (errorData) {
                        errorMsg += 'éŒ¯èª¤è©³æƒ…:\n';
                        errorMsg += JSON.stringify(errorData, null, 2);
                        errorMsg += '\n\n';
                    }
                    
                    if (response.status === 400) {
                        errorMsg += 'ğŸ’¡ å¯èƒ½åŸå› :\n';
                        errorMsg += '- API Key æ ¼å¼éŒ¯èª¤\n';
                        errorMsg += '- è«‹æ±‚åƒæ•¸æœ‰èª¤\n';
                        errorMsg += '\nå»ºè­°:\n';
                        errorMsg += 'é‡æ–°è¤‡è£½ API Key,ç¢ºä¿æ²’æœ‰å¤šé¤˜ç©ºæ ¼';
                    } else if (response.status === 403) {
                        errorMsg += 'ğŸ’¡ å¯èƒ½åŸå› :\n';
                        errorMsg += '- API Key ç„¡æ•ˆæˆ–éæœŸ\n';
                        errorMsg += '- æ²’æœ‰å•Ÿç”¨ Generative Language API\n';
                        errorMsg += '- API Key æ¬Šé™ä¸è¶³\n';
                        errorMsg += '\nè§£æ±ºæ–¹æ³•:\n';
                        errorMsg += '1. å‰å¾€ Google AI Studio æª¢æŸ¥ API Key\n';
                        errorMsg += '2. ç¢ºèªæ˜¯å¦å·²å•Ÿç”¨ API\n';
                        errorMsg += '3. æˆ–é‡æ–°å»ºç«‹ API Key';
                    } else if (response.status === 429) {
                        errorMsg += 'ğŸ’¡ åŸå› :\n';
                        errorMsg += 'è«‹æ±‚æ¬¡æ•¸è¶…éé™åˆ¶\n';
                        errorMsg += '\nå…è²»ç‰ˆé™åˆ¶:\n';
                        errorMsg += '- æ¯åˆ†é˜ 15 æ¬¡\n';
                        errorMsg += '- æ¯å¤© 1500 æ¬¡\n';
                        errorMsg += '\nè«‹ç¨å¾Œå†è©¦';
                    } else if (response.status === 404) {
                        errorMsg += 'ğŸ’¡ å¯èƒ½åŸå› :\n';
                        errorMsg += '- æ¨¡å‹åç¨±ä¸æ­£ç¢º\n';
                        errorMsg += '- API ç‰ˆæœ¬ä¸æ”¯æ´æ­¤æ¨¡å‹\n\n';
                        errorMsg += 'å»ºè­°:\n';
                        errorMsg += 'è«‹ç¢ºèªæ‚¨çš„ API Key æ”¯æ´å“ªäº›æ¨¡å‹';
                    } else if (response.status >= 500) {
                        errorMsg += 'ğŸ’¡ åŸå› :\n';
                        errorMsg += 'Google ä¼ºæœå™¨éŒ¯èª¤\n';
                        errorMsg += 'é€™ä¸æ˜¯ä½ çš„å•é¡Œ,è«‹ç¨å¾Œå†è©¦';
                    }
                    
                    alert(errorMsg);
                    throw new Error('æ¸¬è©¦å¤±æ•—');
                }

                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '(ç„¡å›æ‡‰)';

                let successMsg = 'âœ… API Key æ¸¬è©¦æˆåŠŸ!\n\n';
                successMsg += statusInfo;
                successMsg += `AI å›è¦†: ${reply}\n\n`;
                successMsg += 'ğŸ‘ æ‚¨çš„ API Key å¯ä»¥æ­£å¸¸ä½¿ç”¨';
                
                alert(successMsg);
            } catch (error) {
                if (error.message === 'æ¸¬è©¦å¤±æ•—') {
                    // å·²ç¶“é¡¯ç¤ºééŒ¯èª¤è¨Šæ¯äº†
                } else if (error.message.includes('Failed to fetch')) {
                    await showAlert('âŒ ç¶²è·¯é€£ç·šå¤±æ•—\n\nè«‹æª¢æŸ¥:\n1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n2. æ˜¯å¦é–‹å•Ÿé£›èˆªæ¨¡å¼\n3. WiFi/è¡Œå‹•ç¶²è·¯æ˜¯å¦å¯ç”¨');
                } else {
                    await showAlert('âŒ æœªçŸ¥éŒ¯èª¤\n\n' + error.message);
                }
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // åˆå§‹åŒ–è³‡æ–™åº«ä¸¦è¼‰å…¥è³‡æ–™
        async function initialize() {
            try {
                await initDB();
                await loadDays();
                renderStats();
                
                // è¼‰å…¥è¡¨å–®æš«å­˜
                loadFormDraft();
                
                // è¼‰å…¥æš«å­˜çš„å ±å‘Š
                const savedReport = localStorage.getItem('savedReport');
                if (savedReport) {
                    document.getElementById('editableContent').value = savedReport;
                    document.getElementById('resultContent').textContent = savedReport;
                    document.getElementById('resultSection').classList.add('active');
                }
                
                // å¦‚æœæœ‰è¨˜éŒ„ä½†è¡¨å–®æ˜¯ç©ºçš„,è‡ªå‹•å¡«å…¥æ—…ç¨‹åç¨±
                if (travelDays.length > 0 && !document.getElementById('tripName').value) {
                    document.getElementById('tripName').value = travelDays[0].tripName;
                    document.getElementById('dayNumber').value = travelDays.length + 1;
                    saveFormDraft();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                await showAlert('è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—,è«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨
        initialize();
    </script>
</body>
</html>
